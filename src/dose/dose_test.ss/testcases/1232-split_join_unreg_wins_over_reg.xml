<?xml version="1.0" encoding="utf-8"?>
<object xmlns="urn:safir-dots-unit">
  <name>DoseTest.Items.TestCase</name>
  <members>
    <member>
      <!-- This test is valid only in multinode mode -->
      <name>TestConfig</name>
      <value>DoseTest.TestConfigEnum.Multinode</value>
    </member>
    <member>
      <name>Description</name>
      <value>Checks that a "newer" unreg wins over a reg.</value>
    </member>
    <member>
      <name>Expectation</name>
      <value>Caches in node 0 and node 1 are consistent. No registrations are present. No real instances. Two ghost instances.</value>
    </member>
    <member>
      <name>TestCaseSetupActions</name>
      <arrayElements>
        
        <!-- Register redundant handlers -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.RegisterEntityHandlerPending</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>InstanceIdPolicy</name>
                <value>Safir.Dob.InstanceIdPolicy.RequestorDecidesInstanceId</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.RegisterEntityHandlerPending</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>InstanceIdPolicy</name>
                <value>Safir.Dob.InstanceIdPolicy.RequestorDecidesInstanceId</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- P0 creates an instance -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SetAll</value>
              </member>
              <member>
                <name>Instance</name>
                <value>1</value>
              </member>
              <member>
                <name>Object</name>
                <object>
                  <name>DoseTest.SynchronousVolatileEntity</name>
                  <members>
                    <member>
                      <name>Info</name>
                      <value>Instance 1 created by partner 0, Handler 2</value>
                    </member>
                  </members>
                </object>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- P2 creates an instance -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SetAll</value>
              </member>
              <member>
                <name>Instance</name>
                <value>2</value>
              </member>
              <member>
                <name>Object</name>
                <object>
                  <name>DoseTest.SynchronousVolatileEntity</name>
                  <members>
                    <member>
                      <name>Info</name>
                      <value>Instance 2 created by partner 2, Handler 2</value>
                    </member>
                  </members>
                </object>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>        

        <!-- Disconnect the nodes (assuming that partner 0 and 2 are running in separate nodes) -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.InhibitOutgoingTraffic</value>
              </member>
              <member>
                <name>Inhibit</name>
                <value>True</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.InhibitOutgoingTraffic</value>
              </member>
              <member>
                <name>Inhibit</name>
                <value>True</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <!-- Wait for the nodes to detect the communication failure -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Sleep</value>
              </member>
              <member>
                <name>SleepDuration</name>
                <value>10</value>
              </member>
            </members>
          </object>
        </arrayElement>
      </arrayElements>
    </member>
    <member>
      <name>TestActions</name>
      <arrayElements>
        
        <!-- Now do different things in the disconnected nodes -->

        <!-- HANDLER2: P2 does a number of unreg/reg so the final unreg will become newer than P0's reg -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.UnregisterHandler</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.RegisterEntityHandlerPending</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>InstanceIdPolicy</name>
                <value>Safir.Dob.InstanceIdPolicy.RequestorDecidesInstanceId</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.UnregisterHandler</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Connect the nodes -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.InhibitOutgoingTraffic</value>
              </member>
              <member>
                <name>Inhibit</name>
                <value>False</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.InhibitOutgoingTraffic</value>
              </member>
              <member>
                <name>Inhibit</name>
                <value>False</value>
              </member>
            </members>
          </object>
        </arrayElement>        
        
        <!-- Wait for the nodes to detect each other and to exchange pools -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Sleep</value>
              </member>
              <member>
                <name>SleepDuration</name>
                <value>30</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Check content in node 0 pool -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SubscribeRegistration</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>ALL_HANDLERS</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>RestartSubscription</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.GetEntityIterator</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <!-- Also set up a subscription that gives ghosts -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.InjectorSubscribeEntity</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>IncludeUpdates</name>
                <value>true</value>
              </member>
              <member>
                <name>RestartSubscription</name>
                <value>true</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>WantsGhostDelete</name>
                <value>true</value>
              </member>
              <member>
                <name>WantsLastState</name>
                <value>true</value>
              </member>
              <member>
                <name>DoesntWantSourceIsPermanentStore</name>
                <value>false</value>
              </member>
              <member>
                <name>WantsAllStateChanges</name>
                <value>false</value>
              </member>
              <member>
                <name>TimestampChangeInfo</name>
                <value>false</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Check content in node 1 pool -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SubscribeRegistration</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>ALL_HANDLERS</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>RestartSubscription</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.GetEntityIterator</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <!-- Also set up a subscription that gives ghosts -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.InjectorSubscribeEntity</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>IncludeUpdates</name>
                <value>true</value>
              </member>
              <member>
                <name>RestartSubscription</name>
                <value>true</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>WantsGhostDelete</name>
                <value>true</value>
              </member>
              <member>
                <name>WantsLastState</name>
                <value>true</value>
              </member>
              <member>
                <name>DoesntWantSourceIsPermanentStore</name>
                <value>false</value>
              </member>
              <member>
                <name>WantsAllStateChanges</name>
                <value>false</value>
              </member>
              <member>
                <name>TimestampChangeInfo</name>
                <value>false</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Clean up testcase -->

        <!-- Unsubscribe node 0-->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.UnsubscribeRegistration</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>ALL_HANDLERS</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.UnsubscribeEntity</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Unsubscribe node 1-->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.UnsubscribeRegistration</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>ALL_HANDLERS</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>2</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.UnsubscribeEntity</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>IncludeSubclasses</name>
                <value>true</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        
        <!-- Delete all existing instances -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.RegisterEntityHandlerPending</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>InstanceIdPolicy</name>
                <value>Safir.Dob.InstanceIdPolicy.RequestorDecidesInstanceId</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.DeleteAllInstances</value>
              </member>
              <member>
                <name>TypeId</name>
                <value>DoseTest.SynchronousVolatileEntity</value>
              </member>
              <member>
                <name>Handler</name>
                <value>HANDLER2</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

      </arrayElements>
    </member>
  </members>
</object>

