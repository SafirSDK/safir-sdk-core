<?xml version="1.0" encoding="utf-8"?>
<object xmlns="urn:safir-dots-unit">
  <name>DoseTest.Items.TestCase</name>
  <members>
    <member>
      <name>Description</name>
      <value>Test that a backdoor keeper can be "restarted" when the main connection has been closed and opened in a different context.</value>
    </member>
    <member>
      <name>Expectation</name>
      <value>Partner 0 shall receive command "test-command 1" and "test-command 3"</value>
    </member>
    <member>
      <name>TestCaseSetupActions</name>
      <arrayElements>

        <!-- Make sure Partner 1 is in context 0 so it can send backdoor commands -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Close</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Open</value>
              </member>
              <member>
                <name>Context</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Start with Partner 0 in context 0 -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Close</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Open</value>
              </member>
              <member>
                <name>Context</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.StartBackdoor</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>        
        
        <!-- Send a backdoor command -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SendMessage</value>
              </member>
              <member>
                <name>Channel</name>
                <value>DEFAULT_CHANNEL</value>
              </member>
              <member>
                <name>Object</name>
                <object>
                  <name>Safir.Application.BackdoorCommand</name>
                  <members>
                    <member>
                      <name>ConnectionName</name>
                      <value>.*partner_test_conn.*</value>
                    </member>
                    <member>
                      <name>NodeName</name>
                      <value>.*</value>
                    </member>
                    <member>
                      <name>Command</name>
                      <value>test-command 1</value>
                    </member>
                  </members>
                </object>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Close partner 0 main connection and open it in context 1 -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Close</value>
              </member>
            </members>
          </object>
        </arrayElement>
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.Open</value>
              </member>
              <member>
                <name>Context</name>
                <value>1</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- Send a backdoor command -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SendMessage</value>
              </member>
              <member>
                <name>Channel</name>
                <value>DEFAULT_CHANNEL</value>
              </member>
              <member>
                <name>Object</name>
                <object>
                  <name>Safir.Application.BackdoorCommand</name>
                  <members>
                    <member>
                      <name>ConnectionName</name>
                      <value>.*partner_test_conn.*</value>
                    </member>
                    <member>
                      <name>NodeName</name>
                      <value>.*</value>
                    </member>
                    <member>
                      <name>Command</name>
                      <value>test-command 2</value>
                    </member>
                  </members>
                </object>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>

        <!-- "Restart" the backdoor keeper -->        
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>0</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.StartBackdoor</value>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
        
        <!-- Send a backdoor command -->
        <arrayElement>
          <object>
            <name>DoseTest.Action</name>
            <members>
              <member>
                <name>Partner</name>
                <value>1</value>
              </member>
              <member>
                <name>ActionKind</name>
                <value>DoseTest.ActionEnum.SendMessage</value>
              </member>
              <member>
                <name>Channel</name>
                <value>DEFAULT_CHANNEL</value>
              </member>
              <member>
                <name>Object</name>
                <object>
                  <name>Safir.Application.BackdoorCommand</name>
                  <members>
                    <member>
                      <name>ConnectionName</name>
                      <value>.*partner_test_conn.*</value>
                    </member>
                    <member>
                      <name>NodeName</name>
                      <value>.*</value>
                    </member>
                    <member>
                      <name>Command</name>
                      <value>test-command 3</value>
                    </member>
                  </members>
                </object>
              </member>
              <member>
                <name>Consumer</name>
                <value>0</value>
              </member>
            </members>
          </object>
        </arrayElement>
                
      </arrayElements>
    </member>
  </members>
</object>

