Windows Building and Installing
===============================

Installing Prerequisites
------------------------

First of all there are a number of packages that you need to have installed on your system to be able to build all the parts of Safir SDK Core. 
Here is a summary of what you need, and below are instructions on where to get them and how to install them.

Visual Studio 2005 SP1 or Visual Studio 2008 SP1 or Visual Studio 2010.
GNAT 
MinGW and MSYS
Boost (1.38 or later)
ACE (>5.x)
Qt (>=4.4)
CMake (>=2.6)
Templates-Parser
XMLAda
expat
Python (>= 2.4)
doxygen
graphviz

Visual Studio and utils
~~~~~~~~~~~~~~~~~~~~~~~
You are assumed to already have Visual Studio 2005 SP1 (aka 8.0) or 2008 SP1 (aka 9.0)  or 2010 (aka 10.0) installed, so we proceed immediately to the more interesting bits.
You are also assumed to have some unpacking tool installed that can handle .gz files, like winzip, 7-zip or winrar.

Boost
~~~~~
The easiest way to install boost is to use the installer provided by BoostPro Computing: http://www.boostpro.com. Download the newest installer and run it.
 - In the "Select Default Variants" step, select "Visual C++ 8.0" (or "Visual C++ 9.0"), "Multithread Debug, DLL" and "Multithread, DLL". If you need more variants or compilers, check those as well.
 - In the "Choose Components" step you need at least "Boost DateTime", "Boost Filesystem", "Boost ProgramOptions", "Boost Regex", "Boost System", "Boost Serialization", and "Boost Thread" (again, if you need other things as well, select them too).

Add the lib directory of the boost installation (e.g. C:\Program Files\boost\boost_1_45\lib or similar) to your PATH.

There are a bugs in all current versions of the Boost libraries that need to be patched for Safir SDK to work correctly. In the build/patches/boost directory there are a set of patches for some recent boost versions. Find the appropriate files and copy them over the corresponding files in your boost installation. (You can also use run "cmake . -G 'NMake Makefiles'", "nmake install" once you have installed cmake, which will install the correct patches automatically).

Boost 1.45 is known to work well with all Visual Studio versions. Unfortunately, for some unknown reason, BoostPro Computing doesn't provide a binary installer for 1.45 so you have to download it from boost.org and build it yourself. 

Qt
~~
Note: As of 2012 there is a precompiled vs2008 version of Qt available from Nokia, use that to avoid having to build from source as described below.

Installing Qt is sort of optional. If you don't install it you won't be able to build dobexplorer and one of the example applications. Be aware that building Qt takes a long time (~4h last time I did it). If you decide against installing Qt, you will have to remove the dobexplorer lines from the build/sdk_core_windows.txt file for the build script to complete correctly.

Download the Qt source code from http://qt.nokia.com/downloads, and unzip it to a directory of your choice (must not contain spaces). These instructions assume that you use "C:\Qt".
Create the environment variable QTDIR set it to C:\Qt
Add %QTDIR%\bin and %QTDIR%\lib to your PATH.
Open a Visual Studio command prompt and go to c:\qt. 
 - Run "configure" (I've had some trouble with the qmake.exe that is built by configure, so I had to copy that to C:\Qt\bin and re-run "configure")
 - Run "nmake" (this step takes a very long time to complete, we're building the whole Qt framework from source!)

MinGW and MSYS
~~~~~~~~~~~~~~
MinGW and MSYS are not requirements of Safir SDK Core, but some of the installations of the other prerequisites need more stuff from MinGW and MSYS, so we have to install them. Fortunately, as of 2012 they're now in the same installer, so this step is easier than it used to be.

Download the mingw-get-inst from http://www.mingw.org (direct link: http://sourceforge.net/projects/mingw/files/Installer/mingw-get-inst/) and run it. 
In the "Select Components" step, add MSYS and the Developer Toolkit to the stuff to be installed. Install to C:\MinGW, or you'll get into trouble later.

CMake
~~~~~
Go to http://www.cmake.org/ and download and install the CMake installer.
In the "Install Options" step, check the "Add CMake to the system PATH for all users", or "... current user" if you prefer. (On one of my test machines this didn't work, so I had to add "C:\Program Files\CMake 2.6\bin" to my PATH manually.) 

Expat
~~~~~
Go to http://expat.sourceforge.net/ and download and install the binary installer for windows.
Add C:\Program Files\Expat 2.0.1\Bin to your PATH (or put the DLLs in some dir that is in your PATH).

GNAT and Ada libraries
~~~~~~~~~~~~~~~~~~~~~~
Go to http://libre.adacore.com/ and download the GPL version of GNAT. Also download XMLAda and AWS.
Install GNAT. (and reboot, as the installer says)
Install xmlada:
        unzip xmlada to C:\xmlada
        open a MSYS command prompt (Start --> All Programs --> MinGW --> MinGW shell) and do "cd /c/xmlada"
        run "./configure --prefix=C:/GNAT/2011" (note the direction of the slashes!)
        run "make" and then "make install"
        (delete c:\xmlada, it is no longer needed)

Install AWS:
        unzip aws into c:\aws
        open a MSYS command prompt (Start --> All Programs --> MinGW --> MinGW shell) and do "cd /c/aws"
        run "make setup build install"
        (delete c:\aws since it is no longer needed)

Add c:\GNAT\2011\lib to your PATH.

Java
~~~~
Go to http://java.sun.com/javase/downloads/index.jsp and download and install a JDK kit. (Last time I used "JDK 6 Update 29", since I needed only the jdk itself, but any of the JDK kits should work)

Python
~~~~~~
Go to http://www.python.org/ and download and install the python installer. (Please use a version greater than or equal to 2.4, but less than 3.0, 2.6.1 is recommended).

Add C:\Python26 to your PATH.


Doxygen and Graphviz
~~~~~~~~~~~~~~~~~~~~
These tools are used to build the interface documentation from the C++ source code. 
Go to http://www.doxygen.org/ and download and install the windows installer (direct link: http://ftp.stack.nl/pub/users/dimitri/doxygen-1.6.1-setup.exe).
Go to http://www.graphviz.org/ and download and install the windows installer (direct link: http://www.graphviz.org/pub/graphviz/stable/windows/graphviz-2.24.msi).

It appears that Graphviz installs its own version of libexpat.dll which conflicts with the one we installed above (part of Expat). You have to make sure that the libexpat.dll that we installed above is before the graphviz one in your PATH. 
(If you don't do this you will get an error message about "The ordinal 63 could not be located in the dynamic link library libexpat.dll" when you build Safir SDK Core.)

Now you can jump to "Building Safir SDK Core"


Building Safir SDK Core
-----------------------
First of all you should decide where you want the SDK installed. You have to specify two environment variables, SAFIR_RUNTIME and SAFIR_SDK. For example you can create a directory "C:\safir", and set the variables to point to "C:\safir\runtime" and "C:\safir\sdk" respectively.

Add %SAFIR_RUNTIME%\bin to your PATH.
Add an environment variable ADA_PROJECT_PATH containing %SAFIR_SDK%\ada

#The building of C# applications require one more thing, the creation of a K: drive that points to %SAFIR_RUNTIME%\bin. The reason for this is that Visual Studio does not support the use of environment variables for locating dependent assemblies, and since we don't add the assemblies to the GAC we have to provide some other way of locating them. So create the folder "C:\safir\runtime\bin" (assuming that is where you put your tower), and open a command prompt and run "subst k: %SAFIR_RUNTIME%\bin". (This creates a K: drive that is mapped to C:\safir\runtime\bin. The mapping will disappear when you restart your computer, so if you want it to be persistent put that command in a .bat file and place it in your Startup folder.)

Now open a Visual Studio 2005 command prompt and go to the directory that contains the build and src directories, and run 
    build\build.py -f build\sdk_core.txt

This will build the Safir SDK Core components in the correct order and install them into the location specified by SAFIR_SDK and SAFIR_RUNTIME.

With a bit of luck you should now have a working Safir SDK Core installed on your computer.

Try running start_core.bat (in C:\safir\runtime\bin) to see if everything is working. You should get a dose_main, dope_main and a swre_logger started for you. Try starting sate.exe, and you can start playing around with Safir SDK Core.


Building example applications
-----------------------------
The directory named "examples" contains some test applications. The simplest way to build these is to use the build script with a different configuration file (run after the build of the SDK as described above):
    build/build.py -f build/example_apps.txt
When this is complete you should have a few new applications installed under %SAFIR_RUNTIME%/bin: VehicleAppCpp, VehicleAppCs, VehicleMmiCppQt, VehicleMmiCsWinForms and VehicleAppDb. 
Note: There is also a build script configuration file dob_tests_windows.txt, which builds the Dob test suite.

Setting up library and include paths in Visual Studio
-----------------------------------------------------
To be able to build your own applications using Visual Studio projects/solutions you will have to set up Visual Studio to find the third party stuff.
The instructions below will set up these things for all projects. If you want it for just one project you need to do similar things just to your project settings.

If you do the below step, "Recreating the downloadable binary", you can skip all the things except $(SAFIR_SDK)/include and $(SAFIR_SDK)/lib, since the script described there copies the relevant stuff into the SAFIR_SDK directories.

Open Visual Studio and go to Tools --> Options --> Projects and Solutions --> VC++ Directories:
Add the following under "Include files" (top right combo-box)
    $(ACE_ROOT)
    $(BOOST_DIR)
    C:\Program Files\Expat 2.0.1\Source\lib
    $(SAFIR_SDK)/include
Add the following under "Library files"
    $(ACE_ROOT)/lib
    $(BOOST_DIR)/lib
    C:\Program Files\Expat 2.0.1\Bin
    $(SAFIR_SDK)/lib


Recreating the downloadable binary
----------------------------------
The Windows binary that is available for download at www.safirsdk.com is created by following the above instructions and then running the create_windows_distributable.py script. The script copies necessary dlls, libs and header files into appropriate parts of SAFIR_RUNTIME and SAFIR_SDK, so that those folders can be moved to another computer where it will not be necessary to install/build all of the above prerequisites to be able to develop against the Safir SDK Core.
If you want to do that, open a command prompt and cd to the directory where you ran the build script from and run "create_windows_distributable.py".

