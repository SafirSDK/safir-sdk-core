#!/usr/bin/make -f
.PHONY: override_dh_install install_runtime install_tools install_development install_testsuite override_dh_auto_test override_dh_clideps override_dh_strip

#upstream recommends NDEBUG for release builds!
export CPPFLAGS += -DNDEBUG

%:
	dh $@ --parallel --with=cli

override_dh_auto_install: install_runtime install_tools install_development install_testsuite

install_runtime: export DESTDIR=$(shell pwd)/debian/safir-sdk-core
install_runtime:
	pwd
	ls -l
	env
	#run cmake install
	cd obj-$(DEB_BUILD_GNU_TYPE) && /usr/bin/cmake -DCOMPONENT=Runtime -P cmake_install.cmake

	#copy example configuration to /etc
	dh_install debian/safir-sdk-core/usr/share/doc/safir-sdk-core/example_configuration/*.ini etc/safir-sdk-core

	#create some needed directories
	mkdir -p debian/safir-sdk-core/var/lib/safir-sdk-core

install_tools: export DESTDIR=$(shell pwd)/debian/safir-sdk-core-tools
install_tools:
	cd obj-$(DEB_BUILD_GNU_TYPE) && /usr/bin/cmake -DCOMPONENT=Tools -P cmake_install.cmake

install_development: export DESTDIR=$(shell pwd)/debian/safir-sdk-core-dev
install_development:
	cd obj-$(DEB_BUILD_GNU_TYPE) && /usr/bin/cmake -DCOMPONENT=Development -P cmake_install.cmake

install_testsuite: export DESTDIR=$(shell pwd)/debian/safir-sdk-core-testsuite
install_testsuite:
	cd obj-$(DEB_BUILD_GNU_TYPE) && /usr/bin/cmake -DCOMPONENT=TestSuite -P cmake_install.cmake

override_dh_auto_test:
	touch obj-$(DEB_BUILD_GNU_TYPE)/DartConfiguration.tcl
	cd obj-$(DEB_BUILD_GNU_TYPE) && /usr/bin/ctest --output-on-failure -T Test --no-compress-output


#workaround for bug in cli-common-dev.
override_dh_clideps:
	pwd|grep -q " " && echo "Skipping dh_clideps since there is a space in pwd" || dh_clideps


#make debug symbols go in separate package
override_dh_strip:
	dh_strip --dbg-package=safir-sdk-core-dbg
